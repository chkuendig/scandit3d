<!DOCTYPE html>
<html>

<style>
  html,
  body {
    width: 100%;
    height: 100%;
    margin: 0;
  }
</style>
<style>
  #scanner-container,
  #gl-canvas,
  #testCanvas {
    width: 80vw;
    height: calc(80vw/16*9);
  }

  #scanner-container {

    display: block;
    position: relative;
  }

  /* Position the code location canvas directly over the camera video */
  .code-location-canvas {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    border: 1px solid red;
  }
</style>
<script id="vertex-shader" type="x-shader/x-vertex">

attribute  vec4 vPosition;
attribute  vec4 vColor;
attribute vec2 vTexCoord;

varying vec4 fColor;
varying vec2 fTexCoord;
varying mat4 fDrainMatrix;

uniform mat4 modelViewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 scaleMatrix;
uniform vec4 cameraPos;

uniform int lighting;

void main() 
{
    gl_Position = projectionMatrix*modelViewMatrix*scaleMatrix*vPosition;
    fColor = vColor;
	fTexCoord = vTexCoord;
	float distance = distance(vPosition,cameraPos);
	float drain = (distance < 3.0) ? 1.0 : (3.0/distance - 0.2)/0.8;

	if(lighting==0) drain = 1.0;

	fDrainMatrix = mat4(	drain,  0.0,	0.0,	0.0,
		  		  			0.0,	drain,  0.0,	0.0,
		    				0.0,	0.0,	drain,	0.0,
		    				0.0,	0.0,	0.0,	1.0 );
} 
</script>

<script id="fragment-shader" type="x-shader/x-fragment">

precision mediump float;

uniform int i;

varying vec4 fColor;
varying vec2 fTexCoord;
varying mat4 fDrainMatrix;

uniform sampler2D floor;
uniform sampler2D wall;
uniform sampler2D ceiling;
uniform sampler2D pic;
uniform sampler2D start;
uniform sampler2D fin;
uniform sampler2D open;
uniform sampler2D rat;

void main()
{

    if(i==1) gl_FragColor = fDrainMatrix*texture2D(floor, fTexCoord);
    else if(i==2) gl_FragColor = fDrainMatrix*texture2D(ceiling, fTexCoord);
    else if(i==3) gl_FragColor = fDrainMatrix*texture2D(pic, fTexCoord);
    else if(i==4) gl_FragColor = vec4(texture2D(start, fTexCoord).rgb,texture2D(start, fTexCoord).a*.5);
    else if(i==5) gl_FragColor = vec4(texture2D(fin, fTexCoord).rgb,texture2D(fin, fTexCoord).a*.5);
    else if(i==6) gl_FragColor = vec4(texture2D(open, fTexCoord).rgb,texture2D(open, fTexCoord).a*.5);
    else if(i==7) gl_FragColor = texture2D(rat, fTexCoord);
    else if(i==8) gl_FragColor = fColor;
	else gl_FragColor = fDrainMatrix*texture2D(wall, fTexCoord);
}


</script>

<script src="//cdn.jsdelivr.net/gh/esangel/WebGL/Common/webgl-utils.js"></script>
<script src="//cdn.jsdelivr.net/gh/esangel/WebGL/Common/initShaders.js"></script>
<script src="//cdn.jsdelivr.net/gh/esangel/WebGL/Common/MV.js"></script>
<script src="//cdn.jsdelivr.net/npm/scandit-sdk@4.x"></script>
<script src="//cdn.jsdelivr.net/npm/bwip-js@2.x"></script>
<script src="//cdn.jsdelivr.net/npm/bwip-js@2.x/lib/symdesc.js"></script>

<script>






  /* https://github.com/Scandit/barcodescanner-sdk-for-web-samples/blob/master/vanilla-samples/code-location/index.html */

  // Create the code location canvas element
  var codeLocationCanvasElement = document.createElement("canvas");
  codeLocationCanvasElement.classList.add("code-location-canvas");
  // Set the code location canvas to fit in its parent element in the same way as the camera video inside the barcode picker
  codeLocationCanvasElement.style.objectFit = codeLocationCanvasElement.dataset.objectFit = ScanditSDK.BarcodePicker.ObjectFit.CONTAIN; // Second value used by "objectFitPolyfill" library


  var codeLocationCanvasContext = codeLocationCanvasElement.getContext("2d");


  function drawCodeLocation(location) {
    codeLocationCanvasContext.beginPath();
    codeLocationCanvasContext.moveTo(location.topLeft.x, location.topLeft.y);
    codeLocationCanvasContext.lineTo(location.topRight.x, location.topRight.y);
    codeLocationCanvasContext.lineTo(location.bottomRight.x, location.bottomRight.y);
    codeLocationCanvasContext.lineTo(location.bottomLeft.x, location.bottomLeft.y);
    codeLocationCanvasContext.closePath();
    codeLocationCanvasContext.lineWidth = 3;
    codeLocationCanvasContext.strokeStyle = "rgba(46, 192, 204, 0.6)";
    codeLocationCanvasContext.stroke();
    codeLocationCanvasContext.fillStyle = "rgba(46, 192, 204, 0.3)";
    codeLocationCanvasContext.fill();
  }


  // Configure the library and activate it with a license key
  const licenseKey = "ATe90Ax+EtL1CJWafEolgHUqNSa2FUaEM0Jxsj1wgnIcFv0Sgl9q0GNQWe7ySrPT0hZCg5x4ZGcsC4u+s0uILbR/SP07dvx8/ynmOt98JZl/Fz8zCSq5ZxMO41xbKe4ODVGHblZ0KZ0GaEBfx5BznuZ2pihSbuPL6TV1mbMPKk3399c9T4ZKyC3vSEOMZNfh7noBCKkhsUzwMwXPWggQdQI+A7GWYtxVO5Jg6AN5HnpdchY0xxlJzLNYCjCWjjxCGW0VAO2hTpyDQ4z9OvBISUSf3MU8hZezsBMmJzII0JyN9YjJ/40+At9ywYKborV9qABhS3hq4kpoEOEvB041lrJ7M54BrGFziCpnDyjwdwx85GSK57ComqiVYJ7Pd0wkr2UYeeEaB81sAmTZOOGHlV2qYBmatjGE/yjm4lYlhOsBnudZspbUzDKaZv02MthhZgJY1rSIHa1Rjnnc/n3mpxblcnToVWRFT5T2etDZ9PbWIQQWJtGJP/7MciSXwYA9HuLD8TgCR9JyKF1ZyX8s/gpDRVvSJNGScqw6h9dAv4tJ2hZTYPrWv5xlJXNGgyANADTv9IgrgMIKZfQKxPb99YIBHa40JCkp2OUnVY+K9zLGKswmqpn1p4yAiXiPOtt6f4WMyVKgl3HH+NRQst2RYfWsREYw6KocC8tuO2+vbqDpTEXGz+u0Qv0VfyuHkU9YSiMT92BX5LnaYTZ5MXSsBgImJHut9Z3QsoiTffK0gVmkLrtGVumX/px5tc21BizIyx0z981+oujxkf7r2wqx4h0hQ/grJypQMYDo";
  // Configure the engine location, as explained on http://docs.scandit.com/stable/web/index.html
  // const engineLocation = "build"; // the folder containing the engine
  // or, if using a CDN:
  const engineLocation = "https://cdn.jsdelivr.net/npm/scandit-sdk@4.x/build"
  let scanner;
  ScanditSDK.configure(licenseKey, { engineLocation: engineLocation }).then(() => {
    console.log("ScanditSDK configured")

    const scanSettings = new ScanditSDK.ScanSettings({
      enabledSymbologies: ["ean8", "ean13", "upca", "upce", "code128", "qr"
      ],
      codeDuplicateFilter: 0,
      maxNumberOfCodesPerFrame: 10
    });
    var namedParameters = {
      scanSettings: scanSettings

    }




    scanner = new ScanditSDK.Scanner(namedParameters);
    function refreshImageSettings() {

      var sourceCanvas = document.getElementById("gl-canvas")
      let imageSettings = {
        width: sourceCanvas.width,
        height: sourceCanvas.height,
        format: ScanditSDK.ImageSettings.Format.RGBA_8U
      }

      scanner.applyImageSettings(imageSettings);
    }

    window.addEventListener('resize', function () {
      refreshImageSettings();
    }
      , false);


    scanner.on("ready", function () {
      refreshImageSettings();
      console.log("Scanner Ready");

      document.getElementById("scanner-container").appendChild(codeLocationCanvasElement);
      let wallImg = new Image();
      let staticCanvas = document.getElementById("staticCanvas");
      wallImg.onload = function () {
        let ctx = staticCanvas.getContext("2d");
        let width = wallImg.width;
        let height = wallImg.height;
        staticCanvas.width = width;
        staticCanvas.height = height;
        ctx.drawImage(wallImg, 0, 0);
        imageData = ctx.getImageData(0, 0, width, height).data;
        /* let imageSettings = {
          width: width,
          height: height,
          format: ScanditSDK.ImageSettings.Format.RGBA_8U
        }
       scanner.applyImageSettings(imageSettings);

        scanner.processImage(imageData).then(scanResult => {
          console.log("Initial Scan: " + scanResult.barcodes[0].data);

       
    

        });
      */ }

      wallImg.src = './wall.bmp';
    });
  });





</script>
<script type="text/javascript" src="maze.js"></script>

<body>

  <div id="params">

    <div id="versions"></div>
    <table border=0 cellpading=0 cellspacing=0>
      <tr>
        <td style="vertical-align:top">
          <table border=0 cellpading=0 cellspacing=0>
            <tr>
              <th>Barcode Type:
              <td><select id="symbol"></select>
            <tr>
              <th>Bar Text:
              <td><input id="symtext" type="text">

            <tr>
              <th>Alt Text:
              <td><input id="symaltx" type="text">
            <tr>
              <th>Options:
              <td><input id="symopts" type="text">
            <tr>
              <td>
              <td>
                <div id="stats"></div>
          </table>
        <td style="padding-left:10mm;vertical-align:top">
          <table border=0 cellpading=0 cellspacing=5>
            <tr>
              <th>Scale X,Y:
              <td>
                <input type="number" min=1 max=9 step=1 id="scaleX" value=1>
                <input type="number" min=1 max=9 step=1 id="scaleY" value=1>
            <tr>
              <th>Image Rotation:
              <td>
                <label for="rotateN"><input type="radio" name="rotate" value="N" id="rotateN" checked>Normal</label>
                <label for="rotateR"><input type="radio" name="rotate" value="R" id="rotateR">Right</label>
                <label for="rotateL"><input type="radio" name="rotate" value="L" id="rotateL">Left</label>
                <label for="rotateI"><input type="radio" name="rotate" value="I" id="rotateI">Invert</label>
            <tr>
              <td>
              <td><button style="margin-top:1ex" id="renderBarcode">Show Barcode</button>
          </table>
      <tr>
        <td><br>
    </table>


    <canvas id="staticCanvas" width="261" height="165" style="border: 2px solid #000;"></canvas>

    <input type="button" onclick="javascript:swapTexture();" value="swapTexture">

    <input readonly size="5" id="numberOfCodesPerFrame">
    <input readonly size="5" id="fps">
    <canvas id="barcodeCanvas" width=1 height=1 style="border:1px solid #fff;visibility:hidden"></canvas>

    <div id="output" style="white-space:pre"></div>
    <div id="scanner-container" class="scanner">
      <canvas id="gl-canvas" width="683" height="512">
        Oops ... your browser doesn't support the HTML5 canvas element
      </canvas>
    </div>
    <!-- <img id="texImage" src="http://ee.cooper.edu/~goldfarb/maze/wall.bmp" crossOrigin="use-credentials" hidden></img> -->
    <!-- <canvas id="testCanvas" style="border: 2px solid #000;display:none;"></canvas> -->

</body>

<script>
  var destinationCanvas = document.getElementById("testCanvas")

  var sourceCanvas = document.getElementById("gl-canvas")
  var numberOfCodesPerFrameElement = document.getElementById("numberOfCodesPerFrame")


  window.scanBarcode = function () {


    if (scanner.isReady() && !scanner.isBusyProcessing()) {


      var destCtx = sourceCanvas.getContext('webgl');
      var inputImageData = new Uint8Array(gl.drawingBufferWidth * gl.drawingBufferHeight * 4);
      destCtx.readPixels(0, 0, sourceCanvas.width, sourceCanvas.height, gl.RGBA, gl.UNSIGNED_BYTE, inputImageData);

      const w = sourceCanvas.width, h = sourceCanvas.height;
      var inputImageDataRotated = new Uint8ClampedArray(gl.drawingBufferWidth * gl.drawingBufferHeight * 4);
      Array.from({ length: h },
        function (val, i) { return inputImageData.slice(i * w * 4, (i + 1) * w * 4) })
        .forEach(function (val, i) { return inputImageDataRotated.set(val, (h - i - 1) * w * 4) });


      scanner.processImage(inputImageDataRotated).then(scanResult => {
        /*console.log("Scanned frame: ")
        console.log(scanResult);*/

        // Erase previous code locations
        codeLocationCanvasContext.clearRect(0, 0, codeLocationCanvasContext.canvas.width, codeLocationCanvasContext.canvas.height);
        // Adjust code location canvas context size based on currently active camera resolution
        codeLocationCanvasContext.canvas.width = scanResult.imageSettings.width;
        codeLocationCanvasContext.canvas.height = scanResult.imageSettings.height;
        //   codeLocationCanvasContext.translate(100,100);  // we scanned upside down
        // Mirror code location canvas if the camera image is also mirrored

        // Draw new code locations
        scanResult.barcodes.forEach(function (barcode) {
          drawCodeLocation(barcode.location);
        });
        numberOfCodesPerFrameElement.value = scanResult.barcodes.length;


      })
    };

  }


  function swapTexture() {


    try {
      let renderCanvas = document.getElementById('barcodeCanvas')
      let renderCtx = renderCanvas.getContext("2d");
      imageData = renderCtx.getImageData(0, 0, renderCanvas.width, renderCanvas.height);


      let wallImg = new Image();
      let staticCanvas = document.getElementById("staticCanvas");
      function nextPowerOf2(n) { // https://stackoverflow.com/questions/26965171/fast-nearest-power-of-2-in-javascript
        return 1 << 32 - Math.clz32(n);
      }

      let textureWidth = nextPowerOf2(Math.max(renderCanvas.width * 1.5, renderCanvas.height * 1.5));
      let textureHeight = textureWidth;
      wallImg.onload = function () {
        staticCanvas.width = textureWidth
        staticCanvas.height = textureHeight
        let staticCtx = staticCanvas.getContext("2d");


        staticCtx.drawImage(wallImg, 0, 0, textureWidth, textureHeight);
        staticCtx.putImageData(imageData, (textureWidth - renderCanvas.width) / 2, (textureHeight - renderCanvas.height) / 2);

        const wallTexture = gl.createTexture();
        const TextureData = staticCtx.getImageData(0, 0, textureWidth, textureHeight);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, wallTexture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, TextureData);
        gl.generateMipmap(gl.TEXTURE_2D);

      }

      wallImg.src = './pic.bmp';




    } catch (e) {
      // `e` may be a string or Error object
    }


  }
  function takeScreenshot() {


    var sourceCanvas = document.getElementById("gl-canvas")
    var destinationCanvas = document.getElementById("testCanvas")

    //grab the context from your destination canvas
    var destCtx = destinationCanvas.getContext('2d');

    //call its drawImage() function passing it the source canvas directly
    destCtx.drawImage(sourceCanvas, 0, 0);

    if (scanner.isReady()) {

      imageData = destCtx.getImageData(0, 0, destinationCanvas.width, destinationCanvas.height).data;
      let imageSettings = {
        width: destinationCanvas.width,
        height: destinationCanvas.height,
        format: ScanditSDK.ImageSettings.Format.RGBA_8U
      }
      scanner.applyImageSettings(imageSettings);

      scanner.processImage(imageData).then(scanResult => {
        console.log("Scanned frame: ")
        console.log(scanResult);

        // Erase previous code locations
        codeLocationCanvasContext.clearRect(0, 0, codeLocationCanvasContext.canvas.width, codeLocationCanvasContext.canvas.height);
        // Adjust code location canvas context size based on currently active camera resolution
        codeLocationCanvasContext.canvas.width = scanResult.imageSettings.width;
        codeLocationCanvasContext.canvas.height = scanResult.imageSettings.height;
        // Mirror code location canvas if the camera image is also mirrored

        // Draw new code locations
        scanResult.barcodes.forEach(function (barcode) {
          drawCodeLocation(barcode.location);
        });
      });
    }




  }




  window.addEventListener('load', function () {
    var lastSymbol, lastBarText, lastAltText, lastOptions, lastRotate, lastScaleX, lastScaleY;
    try {
      lastSymbol = localStorage.getItem('bwipjsLastSymbol');
      lastBarText = localStorage.getItem('bwipjsLastBarText');
      lastAltText = localStorage.getItem('bwipjsLastAltText');
      lastOptions = localStorage.getItem('bwipjsLastOptions');
      lastRotate = localStorage.getItem('bwipjsLastRotate');
      lastScaleX = +localStorage.getItem('bwipjsLastScaleX');
      lastScaleY = +localStorage.getItem('bwipjsLastScaleY');
    } catch (e) {
    }

    // Set up the select list of barcode types
    var sel = document.getElementById('symbol');
    var opts = [];
    for (var id in symdesc) {
      opts.push(symdesc[id]);
    }
    opts.sort(function (a, b) { return a.desc < b.desc ? -1 : 1 });
    for (var i = 0, l = opts.length; i < l; i++) {
      var elt = document.createElement('option');
      elt.textContent = opts[i].desc;
      elt.value = opts[i].sym;
      sel.appendChild(elt);
    }

    sel.addEventListener('change', function (ev) {
      var desc = symdesc[sel.value];
      if (desc) {
        document.getElementById('symtext').value = desc.text;
        document.getElementById('symopts').value = desc.opts;
      } else {
        document.getElementById('symtext').value = '';
        document.getElementById('symopts').value = '';
      }
      document.getElementById('symaltx').value = '';
      document.getElementById('stats').textContent = '';

    });

    if (lastSymbol) {
      sel.value = lastSymbol;
    } else {
      sel.selectedIndex = 0;
    }
    var evt = document.createEvent("HTMLEvents");
    evt.initEvent("change", false, true);
    sel.dispatchEvent(evt);

    if (lastBarText) {
      document.getElementById('symtext').value = lastBarText;
      document.getElementById('symaltx').value = lastAltText;
      document.getElementById('symopts').value = lastOptions;
    }
    if (lastScaleX && lastScaleY) {
      document.getElementById('scaleX').value = lastScaleX;
      document.getElementById('scaleY').value = lastScaleY;
    }
    if (lastRotate) {
      document.getElementById('rotate' + lastRotate).checked = true;
    }

    document.getElementById('scaleX').addEventListener('change', function (ev) {
      document.getElementById('scaleY').value = ev.target.value;
    });
    document.getElementById('renderBarcode').addEventListener('click', renderBarcode);

    // Allow Enter to render
    document.getElementById('params').addEventListener('keypress', function (ev) {
      if (ev.which == 13) {
        renderBarcode();
        ev.stopPropagation();
        ev.preventDefault();
        return false;
      }
    });

    document.getElementById('versions').textContent =
      'bwip-js ' + bwipjs.VERSION + ' / BWIPP ' + bwipjs.BWIPP.VERSION;
  });



  function renderBarcode() {
    var elt = symdesc[document.getElementById('symbol').value];
    var text = document.getElementById('symtext').value.trim();
    var alttext = document.getElementById('symaltx').value.trim();
    var options = document.getElementById('symopts').value.trim();
    var rotate = document.querySelector('input[name="rotate"]:checked').value;
    var scaleX = +document.getElementById('scaleX').value || 2;
    var scaleY = +document.getElementById('scaleY').value || 2;

    try {
      localStorage.setItem('bwipjsLastSymbol', elt.sym);
      localStorage.setItem('bwipjsLastBarText', text);
      localStorage.setItem('bwipjsLastAltText', alttext);
      localStorage.setItem('bwipjsLastOptions', options);
      localStorage.setItem('bwipjsLastScaleX', scaleX);
      localStorage.setItem('bwipjsLastScaleY', scaleY);
      localStorage.setItem('bwipjsLastRotate', rotate);
    } catch (e) {
    }

    // Clear the page
    document.getElementById('output').value = '';
    document.getElementById('stats').value = '';
    document.getElementById('output').textContent = '';

    var canvas = document.getElementById('barcodeCanvas');
    canvas.height = 1;
    canvas.width = 1;
    canvas.style.visibility = 'hidden';

    // Convert the options to an object.
    let opts = {
      backgroundcolor: 'FFFFFF'
    };
    let aopts = options.split(' ');
    for (let i = 0; i < aopts.length; i++) {
      if (!aopts[i]) {
        continue;
      }
      var eq = aopts[i].indexOf('=');
      if (eq == -1) {
        opts[aopts[i]] = true;
      } else {
        opts[aopts[i].substr(0, eq)] = aopts[i].substr(eq + 1);
      }
    }

    // Finish up the options
    opts.text = text;
    opts.bcid = elt.sym;
    opts.scaleX = 1// scaleX;
    opts.scaleY = 1// scaleY;
    opts.rotate = rotate;
    if (alttext) {
      opts.alttext = alttext;
    }

    // Draw the bar code to the canvas
    try {
      let ts0 = new Date;
      bwipjs.toCanvas(canvas, opts);
      show(ts0, new Date);
    } catch (e) {
      // Watch for BWIPP generated raiseerror's.
      var msg = ('' + e).trim();
      if (msg.indexOf("bwipp.") >= 0) {
        document.getElementById('output').textContent = msg;
      } else if (e.stack) {
        // GC includes the message in the stack.  FF does not.
        document.getElementById('output').textContent =
          (e.stack.indexOf(msg) == -1 ? msg + '\n' : '') + e.stack;
      } else {
        document.getElementById('output').textContent = msg;
      }
      return;
    }

    function show(ts0, ts1) {
      canvas.style.visibility = 'visible';
      document.getElementById('stats').textContent = 'Rendered in ' + (ts1 - ts0) + ' msecs.';
    }
  }
</script>

</html>